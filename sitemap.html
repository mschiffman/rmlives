<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>French Site Map</title>
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-CHXHM9CZKM"
    ></script>

    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-CHXHM9CZKM");
    </script>

    <!-- Favicons -->
    <link href="/img/favicon.png" rel="icon" />

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        background: #1e1e1e;
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        overflow: hidden;
      }

      #graph {
        width: 100vw;
        height: 100vh;
      }

      .node {
        cursor: default; /* Default arrow */
        transition: all 0.3s ease;
      }

      /* Add this new rule to show the pointer only on clickable nodes */
      .node.has-link {
        cursor: pointer;
      }

      .node circle {
        stroke: none;
        transition: all 0.3s ease;
      }

      .node.main-node circle {
        stroke: none;
      }

      .node text {
        fill: #e0e0e0;
        font-size: 12px;
        text-anchor: middle;
        pointer-events: none;
        user-select: none;
        paint-order: stroke;
        stroke: #1e1e1e;
        stroke-width: 1px;
        stroke-linejoin: round;
      }

      .node.highlighted circle {
        fill: #007bff;
        filter: drop-shadow(0 0 8px #007bff);
      }

      .node.highlighted text {
        fill: #ffffff;
      }

      .node.dimmed circle {
        fill: #2a2a2a;
        stroke: #3a3a3a;
        opacity: 0.3;
      }

      .node.dimmed text {
        opacity: 0.3;
      }

      .link {
        stroke: #4a4a4a;
        stroke-width: 1px;
        stroke-opacity: 0.6;
        transition: all 0.3s ease;
      }

      .link.highlighted {
        stroke: #007bff;
        stroke-opacity: 1;
        filter: drop-shadow(0 0 4px #007bff);
      }

      .link.dimmed {
        stroke: #2a2a2a;
        stroke-opacity: 0.2;
      }

      .info-panel {
        position: absolute;
        top: 20px;
        left: 20px;
        background: rgba(40, 40, 40, 0.9);
        padding: 15px 20px;
        border-radius: 8px;
        color: #e0e0e0;
        font-size: 14px;
        border: 1px solid #4a4a4a;
        max-width: 300px;
      }

      .info-panel h3 {
        margin: 0 0 10px 0;
        color: #8b5cf6;
        font-size: 16px;
      }

      #legend {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
      }

      .legend-item {
        display: flex;
        align-items: center;
        cursor: pointer;
        font-size: 12px;
        color: #e0e0e0;
      }

      .legend-circle {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 5px;
        border: 2px solid;
      }

      .info-panel p {
        margin: 5px 0;
        line-height: 1.5;
      }

      .info-panel .shortcut {
        color: #a78bfa;
        font-weight: bold;
      }

      .hidden {
        display: none !important;
      }

      .controls {
        display: flex;
        gap: 10px;
        margin: 10px 0;
      }

      .control-btn {
        background: #333;
        border: 1px solid #555;
        color: #e0e0e0;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 11px;
        text-decoration: none;
        text-align: center;
      }

      .control-btn:hover {
        background: #444;
        border-color: #8b5cf6;
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(3px);
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background-color: #2a2a2a;
        padding: 30px;
        border-radius: 12px;
        border: 1px solid #4a4a4a;
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
        max-width: 600px;
        width: auto; /* Adapts to content */
        min-width: 300px;
        position: relative;
        color: #e0e0e0;
        animation: modalFadeIn 0.3s ease-out;
      }

      @keyframes modalFadeIn {
        from {
          opacity: 0;
          transform: scale(0.9);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      .close-button {
        position: absolute;
        top: 10px;
        right: 15px;
        color: #8b5cf6;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.2s;
      }

      .close-button:hover {
        color: #fff;
      }

      #modalTitle {
        margin-top: 0;
        color: #8b5cf6;
        border-bottom: 1px solid #4a4a4a;
        padding-bottom: 10px;
        margin-bottom: 15px;
      }

      #modalBody {
        line-height: 1.6;
        margin-bottom: 20px;
      }

      .modal-link-btn {
        display: inline-block;
        background-color: #007bff;
        color: white;
        padding: 8px 16px;
        border-radius: 4px;
        text-decoration: none;
        transition: background-color 0.2s;
      }

      .modal-link-btn:hover {
        background-color: #0056b3;
      }
    </style>
  </head>
  <body>
    <div class="info-panel">
      <h3>Nodes</h3>
      <p>
        Click a cluster to show/hide related pages from the network. Click on a
        node to go to the web page.
      </p>
      <div class="controls">
        <button id="check-all" class="control-btn">Check all</button>
        <button id="uncheck-all" class="control-btn">Uncheck all</button>
        <a href="fr/brain/index.html" class="control-btn"
          >Go to Brain & Learning</a
        >
      </div>
      <div id="legend"></div>
    </div>

    <!-- Node Info Modal -->
    <div id="nodeModal" class="modal">
      <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2 id="modalTitle"></h2>
        <p id="modalBody"></p>
        <a id="modalLink" href="#" target="_blank" class="modal-link-btn"
          >Visit Page</a
        >
      </div>
    </div>

    <svg id="graph"></svg>

    <script>
      // Graph data structure
      const graphData = {
        nodes: [
          // Main nodes
          {
            id: "Steps",
            group: 0,
            level: 0,
            url: "fr/steps/index.html",
          },
          {
            id: "Enunciation",
            group: 1,
            level: 0,
          },
          {
            id: "Pronunciation",
            group: 2,
            level: 0,
          },
          {
            id: "Grammar",
            group: 3,
            level: 0,
            url: "fr/grammar/index.html",
          },
          {
            id: "Reading",
            group: 4,
            level: 0,
          },
          {
            id: "Expressions",
            group: 5,
            level: 0,
          },
          {
            id: "Comedy",
            group: 6,
            level: 0,
          },
          {
            id: "Everyday",
            group: 7,
            level: 0,
          },

          // Enun children
          {
            id: " Vowel",
            group: 1,
            level: 1,
          },
          {
            id: " Consonant",
            group: 1,
            level: 1,
            url: "fr/enunciation/consonant.html",
          },
          {
            id: " Liaison",
            group: 1,
            level: 1,
            url: "fr/enunciation/liaison.html",
          },
          {
            id: " Recap",
            group: 1,
            level: 1,
          },

          // Enunciation grandchildren
          {
            id: " Oral",
            group: 1,
            level: 2,
            url: "fr/enunciation/vowel.html",
          },
          {
            id: " Nasal",
            group: 1,
            level: 2,
            url: "fr/enunciation/nasal.html",
          },
          {
            id: " R-Oral",
            group: 1,
            level: 2,
            url: "fr/enunciation/recap-vowel.html",
          },
          // Grammar children
          {
            id: "Noun",
            group: 3,
            level: 1,
          },
          {
            id: "Tense",
            group: 3,
            level: 1,
            url: "fr/grammar/tense/index.html",
          },

          // Grammar grandchildren
          {
            id: "body",
            group: 3,
            level: 2,
            url: "fr/grammar/noun/body.html",
          },
          {
            id: "house",
            group: 3,
            level: 2,
            url: "fr/grammar/noun/house.html",
          },
          {
            id: "landforms",
            group: 3,
            level: 2,
            url: "fr/grammar/noun/landforms.html",
          },
          {
            id: "kitchen",
            group: 3,
            level: 2,
            url: "fr/grammar/noun/kitchen.html",
          },
          {
            id: "present",
            group: 3,
            level: 2,
            url: "fr/grammar/tense/present.html",
          },
          {
            id: "past",
            group: 3,
            level: 2,
            url: "fr/grammar/tense/passe.html",
          },
          {
            id: "future",
            group: 3,
            level: 2,
            url: "fr/grammar/tense/future.html",
          },
          {
            id: "imperfect",
            group: 3,
            level: 2,
            url: "fr/grammar/tense/imparfait.html",
          },
          {
            id: "conditional",
            group: 3,
            level: 2,
            url: "fr/grammar/tense/conditionnel.html",
          },
          {
            id: "subjonctif",
            group: 3,
            level: 2,
            url: "fr/grammar/tense/subjonctif.html",
          },
          // Steps children
          {
            id: "Cloze Test",
            group: 0,
            level: 1,
            url: "fr/grammar/noun/utensils/cloze.html",
          },
          {
            id: "anki",
            group: 0,
            level: 1,
            url: "fr/grammar/noun/utensils/anki_noun.html",
          },
          {
            id: "Collocation web",
            group: 0,
            level: 1,
            url: "fr/grammar/noun/utensils/fork.html",
          },
          {
            id: "Venn",
            group: 0,
            level: 1,
            url: "fr/grammar/noun/utensils/coupant.html",
          },
          {
            id: "Hotspots",
            group: 0,
            level: 1,
            url: "fr/grammar/noun/utensils/hotspot.html",
          },
          {
            id: "Exercises",
            group: 0,
            level: 1,
          },

          {
            id: "Brain & Learning",
            group: 0,
            level: 2,
            url: "fr/brain/index.html",
          },

          // Steps grandchildren
          {
            id: "Read",
            group: 0,
            level: 2,
            url: "fr/grammar/noun/utensils/read.html",
          },
          {
            id: "Listen",
            group: 0,
            level: 2,
            url: "fr/grammar/noun/utensils/listen.html",
          },
          {
            id: "Listen Master",
            group: 0,
            level: 2,
            url: "fr/grammar/noun/utensils/listen-master.html",
          },
          {
            id: "Role Play",
            group: 0,
            level: 2,
            url: "fr/grammar/noun/utensils/rolePlay1.html",
          },
          {
            id: "Reorder",
            group: 0,
            level: 2,
            url: "fr/grammar/noun/utensils/reorder.html",
          },
          {
            id: "Drag and Drop",
            group: 0,
            level: 2,
            url: "fr/grammar/noun/utensils/venn.html",
          },
          {
            id: "Translation",
            group: 0,
            level: 2,
            url: "fr/grammar/noun/utensils/translation.html",
          },
          {
            id: "Create",
            group: 0,
            level: 2,
            url: "fr/grammar/noun/utensils/create.html",
          },

          // Reading children
          {
            id: "Culture",
            group: 4,
            level: 1,
          },
          {
            id: "History",
            group: 4,
            level: 1,
          },
          {
            id: "Nature",
            group: 4,
            level: 1,
          },
          {
            id: "Health",
            group: 4,
            level: 1,
          },
          {
            id: "Science",
            group: 4,
            level: 1,
          },

          // Reading grandchildren
          {
            id: "Dimanche",
            group: 4,
            level: 2,
            url: "fr/reading/index.html",
          },
          {
            id: "Wolf",
            group: 4,
            level: 2,
            url: "fr/reading/wolf.html",
          },
          {
            id: "Beaver",
            group: 4,
            level: 2,
            url: "fr/reading/beaver.html",
          },
          {
            id: "Beluga",
            group: 4,
            level: 2,
            url: "fr/reading/beluga.html",
          },
          {
            id: "Bumblebee",
            group: 4,
            level: 2,
            url: "fr/reading/bumblebee.html",
          },
          {
            id: "Tree",
            group: 4,
            level: 2,
            url: "fr/reading/tree.html",
          },
          {
            id: "Groundwater",
            group: 4,
            level: 2,
            url: "fr/reading/groundwater.html",
          },
          {
            id: "Water Cycle",
            group: 4,
            level: 2,
            url: "fr/reading/water.html",
          },
          {
            id: "Amber",
            group: 4,
            level: 2,
            url: "fr/reading/amber.html",
          },
          {
            id: "Floating Market",
            group: 4,
            level: 2,
            url: "fr/reading/float.html",
          },
          {
            id: "Giethoorn",
            group: 4,
            level: 2,
            url: "fr/reading/giethoorn.html",
          },
          {
            id: "Cholesterol",
            group: 4,
            level: 2,
            url: "fr/reading/cholesterol.html",
          },
          {
            id: "Brain",
            group: 4,
            level: 2,
            url: "fr/reading/brain.html",
          },
          {
            id: "Geothermal",
            group: 4,
            level: 2,
            url: "fr/reading/geothermal.html",
          },

          // Pronunciation children
          {
            id: "French",
            group: 2,
            level: 1,
            url: "fr/pron/RFI260202/index.html",
          },
          {
            id: "English",
            group: 2,
            level: 1,
            url: "fr/pron/E251218/index.html",
          },

          // Expressions children
          {
            id: "Admiration",
            group: 5,
            level: 1,
            url: "fr/expression/admiration.html",
          },
          {
            id: "Agree/Disagree",
            group: 5,
            level: 1,
            url: "fr/expression/agree.html",
          },
          {
            id: "Annoyance",
            group: 5,
            level: 1,
            url: "fr/expression/annoyance.html",
          },
          {
            id: "Help",
            group: 5,
            level: 1,
            url: "fr/expression/help.html",
          },
          {
            id: "Compliment",
            group: 5,
            level: 1,
            url: "fr/expression/compliment.html",
          },
          {
            id: "Connectors",
            group: 5,
            level: 1,
            url: "fr/expression/connectors.html",
          },
          {
            id: "Disbelief",
            group: 5,
            level: 1,
            url: "fr/expression/disbelief.html",
          },
          {
            id: "Excitement",
            group: 5,
            level: 1,
            url: "fr/expression/excitement.html",
          },
          {
            id: "Gratitude",
            group: 5,
            level: 1,
            url: "fr/expression/thank.html",
          },
          {
            id: "Filler",
            group: 5,
            level: 1,
            url: "fr/expression/fillers.html",
          },
          {
            id: "Suggestion",
            group: 5,
            level: 1,
            url: "fr/expression/suggestion.html",
          },
          {
            id: "Understanding",
            group: 5,
            level: 1,
            url: "fr/expression/understand.html",
          },

          // Comedy children
          {
            id: "-2025",
            group: 6,
            level: 1,
            url: "comedy/november.html",
          },

          // Everyday children
          {
            id: "Conv1",
            group: 7,
            level: 1,
            url: "fr/everyday/conv1.html",
          },

          {
            id: "Marché",
            group: 7,
            level: 1,
            url: "fr/everyday/marche.html",
          },
          {
            id: "Route",
            group: 7,
            level: 1,
            url: "fr/everyday/route.html",
          },
          {
            id: "Pharmacie",
            group: 7,
            level: 1,
            url: "fr/everyday/pharmacie.html",
          },
          {
            id: "Supermarche",
            group: 7,
            level: 1,
            url: "fr/everyday/supermarche.html",
          },
          {
            id: "Vêtement",
            group: 7,
            level: 1,
            url: "fr/everyday/vetement.html",
          },
          {
            id: "Telephone",
            group: 7,
            level: 1,
            url: "fr/everyday/telephone.html",
          },
          {
            id: "Aimer",
            group: 7,
            level: 1,
            url: "fr/everyday/aimer_detester.html",
          },
          {
            id: "Temps",
            group: 7,
            level: 1,
            url: "fr/everyday/date_heure.html",
          },
          {
            id: "Voyage",
            group: 7,
            level: 1,
            url: "fr/everyday/voyage.html",
          },
          {
            id: "Meteo",
            group: 7,
            level: 1,
            url: "fr/everyday/meteo.html",
          },
        ],
        links: [
          // Enunciation connections
          { source: "Enunciation", target: " Vowel" },
          { source: "Enunciation", target: " Consonant" },
          { source: "Enunciation", target: " Liaison" },
          { source: "Enunciation", target: " Recap" },
          { source: " Vowel", target: " Oral" },
          { source: " Vowel", target: " Nasal" },
          { source: " Recap", target: " R-Oral" },
          // { source: " Recap", target: " Nasal" },

          // Grammar connections
          { source: "Grammar", target: "Noun" },
          { source: "Grammar", target: "Tense" },
          { source: "Noun", target: "body" },
          { source: "Noun", target: "house" },
          { source: "Noun", target: "landforms" },
          { source: "Noun", target: "kitchen" },
          { source: "Tense", target: "present" },
          { source: "Tense", target: "future" },
          { source: "Tense", target: "past" },
          { source: "Tense", target: "imperfect" },
          { source: "Tense", target: "conditional" },
          { source: "Tense", target: "subjonctif" },

          // Steps connections
          { source: "Steps", target: "Cloze Test" },
          { source: "Steps", target: "anki" },
          { source: "Steps", target: "Collocation web" },
          { source: "Steps", target: "Venn" },
          { source: "Steps", target: "Hotspots" },
          { source: "Steps", target: "Cloze Test" },
          { source: "Steps", target: "Exercises" },
          { source: "Steps", target: "Brain & Learning" },
          { source: "Exercises", target: "Read" },
          { source: "Exercises", target: "Listen" },
          { source: "Exercises", target: "Listen Master" },
          { source: "Exercises", target: "Role Play" },
          { source: "Exercises", target: "Reorder" },
          { source: "Exercises", target: "Drag and Drop" },
          { source: "Exercises", target: "Translation" },
          { source: "Exercises", target: "Create" },

          // Reading connections
          { source: "Reading", target: "Culture" },
          { source: "Reading", target: "History" },
          { source: "Reading", target: "Nature" },
          { source: "Reading", target: "Health" },
          { source: "Reading", target: "Science" },
          { source: "Reading", target: "History" },
          { source: "Culture", target: "Dimanche" },
          { source: "Nature", target: "Wolf" },
          { source: "Nature", target: "Beaver" },
          { source: "Nature", target: "Beluga" },
          { source: "Nature", target: "Bumblebee" },
          { source: "Nature", target: "Tree" },
          { source: "Nature", target: "Groundwater" },
          { source: "Nature", target: "Water Cycle" },
          { source: "Nature", target: "Amber" },
          { source: "History", target: "Floating Market" },
          { source: "History", target: "Giethoorn" },
          { source: "Health", target: "Cholesterol" },
          { source: "Health", target: "Brain" },
          { source: "Science", target: "Geothermal" },

          // Pronunciation connections
          { source: "Pronunciation", target: "French" },
          { source: "Pronunciation", target: "English" },

          // Expressions connections
          { source: "Expressions", target: "Admiration" },
          { source: "Expressions", target: "Agree/Disagree" },
          { source: "Expressions", target: "Annoyance" },
          { source: "Expressions", target: "Help" },
          { source: "Expressions", target: "Compliment" },
          { source: "Expressions", target: "Connectors" },
          { source: "Expressions", target: "Disbelief" },
          { source: "Expressions", target: "Excitement" },
          { source: "Expressions", target: "Gratitude" },
          { source: "Expressions", target: "Filler" },
          { source: "Expressions", target: "Suggestion" },
          { source: "Expressions", target: "Understanding" },

          // Comedy connections
          { source: "Comedy", target: "-2025" },

          // Everyday connections
          { source: "Everyday", target: "Conv1" },
          { source: "Everyday", target: "Marché" },
          { source: "Everyday", target: "Route" },
          { source: "Everyday", target: "Pharmacie" },
          { source: "Everyday", target: "Supermarche" },
          { source: "Everyday", target: "Vêtement" },
          { source: "Everyday", target: "Telephone" },
          { source: "Everyday", target: "Aimer" },
          { source: "Everyday", target: "Temps" },
          { source: "Everyday", target: "Voyage" },
          { source: "Everyday", target: "Meteo" },
        ],
      };

      // Modal Logic
      const modal = document.getElementById("nodeModal");
      const closeBtn = document.querySelector(".close-button");
      const modalTitle = document.getElementById("modalTitle");
      const modalBody = document.getElementById("modalBody");
      const modalLink = document.getElementById("modalLink");

      function openModal(d) {
        modalTitle.textContent = d.id;
        // Use description if available in data, otherwise generic text
        modalBody.textContent =
          d.description ||
          `This is the node for "${d.id}". It is part of the ${d.group} group.`;

        if (d.url) {
          modalLink.href = d.url;
          modalLink.style.display = "inline-block";
          modalLink.textContent = "Go to Page";
        } else {
          modalLink.style.display = "none";
        }

        modal.style.display = "flex";
      }

      closeBtn.onclick = () => (modal.style.display = "none");
      window.onclick = (event) => {
        if (event.target === modal) modal.style.display = "none";
      };

      // Set up SVG
      const width = window.innerWidth;
      const height = window.innerHeight;

      const svg = d3
        .select("#graph")
        .attr("width", width)
        .attr("height", height);

      // Create zoom behavior
      const g = svg.append("g");

      const zoom = d3
        .zoom()
        .scaleExtent([0.1, 4])
        .on("zoom", (event) => {
          g.attr("transform", event.transform);

          const k = event.transform.k;
          const fontSize = k * 12 > 14.2 ? 14.2 / k : 12;
          g.selectAll(".node text").style("font-size", fontSize + "px");
        });

      svg.call(zoom);

      // Create force simulation
      const simulation = d3
        .forceSimulation(graphData.nodes)
        .force(
          "link",
          d3
            .forceLink(graphData.links)
            .id((d) => d.id)
            .distance(80),
        )
        .force("charge", d3.forceManyBody().strength(-120))
        .force("center", d3.forceCenter(width / 2, height / 2))
        .force("x", d3.forceX(width / 2).strength(0.08))
        .force("y", d3.forceY(height / 2).strength(0.08))
        .force("collision", d3.forceCollide().radius(20));

      // Create links
      const link = g
        .append("g")
        .selectAll("line")
        .data(graphData.links)
        .enter()
        .append("line")
        .attr("class", "link");

      // Create nodes
      const node = g
        .append("g")
        .selectAll("g")
        .data(graphData.nodes)
        .enter()
        .append("g")
        // Add this line below to toggle the pointer cursor class
        .classed("has-link", (d) => !!d.url)
        .attr("class", (d) => (d.level === 0 ? "node main-node" : "node"))
        .call(
          d3
            .drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended),
        );

      // Color scale
      const baseColor = d3.scaleOrdinal(d3.schemeCategory10);
      const color = (group) => {
        if (group === 7) return "#06E7ED"; // Custom color for Everyday (Group 7)
        return baseColor(group);
      };

      // Add circles to nodes
      node
        .append("circle")
        .attr("r", (d) => (d.level === 0 ? 12 : d.level === 1 ? 8 : 6))
        .attr("fill", (d) => color(d.group));

      // Legend Logic
      const legendContainer = d3.select("#legend");
      const hiddenGroups = new Set();

      // Get unique groups and their labels (level 0 node id)
      const groups = [...new Set(graphData.nodes.map((d) => d.group))].sort();
      const groupLabels = {};
      graphData.nodes.forEach((n) => {
        if (n.level === 0) groupLabels[n.group] = n.id;
      });

      groups.forEach((groupId) => {
        const colorVal = color(groupId);
        const item = legendContainer
          .append("div")
          .attr("class", "legend-item")
          .on("click", () => toggleGroup(groupId));

        item
          .append("div")
          .attr("class", "legend-circle")
          .style("background-color", colorVal)
          .style("border-color", colorVal)
          .attr("data-group", groupId);

        item.append("span").text(groupLabels[groupId] || `Group ${groupId}`);
      });

      d3.select("#check-all").on("click", () => {
        hiddenGroups.clear();
        updateVisibility();
        updateLegendUI();
      });

      d3.select("#uncheck-all").on("click", () => {
        groups.forEach((g) => hiddenGroups.add(g));
        updateVisibility();
        updateLegendUI();
      });

      function toggleGroup(groupId) {
        if (hiddenGroups.has(groupId)) {
          hiddenGroups.delete(groupId);
        } else {
          hiddenGroups.add(groupId);
        }
        updateVisibility();
        updateLegendUI();
      }

      function updateLegendUI() {
        d3.selectAll(".legend-circle").each(function () {
          const el = d3.select(this);
          const gId = +el.attr("data-group");
          const colorVal = color(gId);
          el.style(
            "background-color",
            hiddenGroups.has(gId) ? "transparent" : colorVal,
          );
        });
      }

      function updateVisibility() {
        node.classed("hidden", (d) => hiddenGroups.has(d.group));
        link.classed(
          "hidden",
          (d) =>
            hiddenGroups.has(d.source.group) ||
            hiddenGroups.has(d.target.group),
        );
      }

      // Add labels to nodes
      node
        .append("text")
        .attr("dy", (d) => (d.level === 0 ? -18 : -14))
        .text((d) => d.id);

      // Hover handling
      node
        .on("mouseover", function (event, d) {
          highlightNode(d);
        })
        .on("mouseout", function () {
          clearHighlight();
        })
        .on("click", function (event, d) {
          event.stopPropagation();
          // Check if the node has a URL
          if (d.url) {
            // Open in new tab ('_blank')
            window.open(d.url, "_blank");
          }
        });

      function highlightNode(selectedNode) {
        // Find all connected nodes
        const connectedNodes = new Set([selectedNode.id]);
        const connectedLinks = new Set();

        // Get descendants (children and grandchildren)
        function addDescendants(nodeId) {
          graphData.links.forEach((link) => {
            const sourceId =
              typeof link.source === "object" ? link.source.id : link.source;
            const targetId =
              typeof link.target === "object" ? link.target.id : link.target;

            if (sourceId === nodeId) {
              connectedNodes.add(targetId);
              connectedLinks.add(link);
              addDescendants(targetId);
            }
          });
        }

        addDescendants(selectedNode.id);

        // Update nodes
        node
          .classed("highlighted", (d) => connectedNodes.has(d.id))
          .classed("dimmed", (d) => !connectedNodes.has(d.id));

        // Update links
        link
          .classed("highlighted", (d) => connectedLinks.has(d))
          .classed("dimmed", (d) => !connectedLinks.has(d));
      }

      function clearHighlight() {
        node.classed("highlighted", false).classed("dimmed", false);
        link.classed("highlighted", false).classed("dimmed", false);
      }

      // Update positions on simulation tick
      simulation.on("tick", () => {
        link
          .attr("x1", (d) => d.source.x)
          .attr("y1", (d) => d.source.y)
          .attr("x2", (d) => d.target.x)
          .attr("y2", (d) => d.target.y);

        node.attr("transform", (d) => `translate(${d.x},${d.y})`);
      });

      // Drag functions
      function dragstarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
      }

      function dragged(event, d) {
        d.fx = event.x;
        d.fy = event.y;
      }

      function dragended(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
      }

      // Handle window resize
      window.addEventListener("resize", () => {
        const newWidth = window.innerWidth;
        const newHeight = window.innerHeight;
        svg.attr("width", newWidth).attr("height", newHeight);
        simulation.force("center", d3.forceCenter(newWidth / 2, newHeight / 2));
        simulation.force("x", d3.forceX(newWidth / 2).strength(0.08));
        simulation.force("y", d3.forceY(newHeight / 2).strength(0.08));
        simulation.alpha(0.3).restart();
      });
    </script>
  </body>
</html>
