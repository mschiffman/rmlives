<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Smart Dictation - Au March√©</title>
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-CHXHM9CZKM"
    ></script>

    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-CHXHM9CZKM");
    </script>

    <!-- Favicons -->
    <link href="/img/favicon.png" rel="icon" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
    />
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        background: #f0f2f5;
        display: flex;
        justify-content: center;
        padding: 20px;
      }

      .dictation-card {
        background: white;
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        max-width: 600px;
        width: 100%;
      }

      h2 {
        text-align: center;
        color: #2c3e50;
        margin-bottom: 10px;
      }

      /* Level Controls */
      .level-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        background: #f8f9fa;
        padding: 10px;
        border-radius: 8px;
      }

      .level-btn {
        background: white;
        border: 1px solid #dcdcdc;
        padding: 5px 15px;
        border-radius: 20px;
        cursor: pointer;
        font-weight: bold;
        color: #7f8c8d;
        transition: all 0.2s;
      }
      .level-btn:hover {
        background: #ecf0f1;
        color: #2c3e50;
      }
      .level-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
      }

      .level-indicator {
        font-weight: bold;
        color: #3498db;
        text-transform: uppercase;
        font-size: 0.9rem;
      }

      /* Audio Controls */
      .audio-controls {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 25px;
      }

      .btn-audio {
        background: #e1f5fe;
        color: #0288d1;
        border: none;
        padding: 10px 20px;
        border-radius: 25px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .btn-audio:hover {
        background: #b3e5fc;
        transform: scale(1.05);
      }
      .btn-slow {
        background: #fff3e0;
        color: #f57c00;
      }
      .btn-slow:hover {
        background: #ffe0b2;
      }

      textarea {
        width: 100%;
        height: 80px;
        padding: 15px;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        font-size: 1.1rem;
        font-family: "Segoe UI", sans-serif;
        resize: none;
        box-sizing: border-box;
        transition: border-color 0.3s;
      }

      textarea:focus {
        outline: none;
        border-color: #3498db;
      }

      .feedback-area {
        margin-top: 20px;
        padding: 15px;
        border-radius: 8px;
        background: #fafafa;
        border: 1px dashed #ccc;
        min-height: 40px;
        font-size: 1.1rem;
        line-height: 1.6;
      }

      /* Diff Styling */
      .diff-correct {
        color: #27ae60;
        font-weight: bold;
      }
      .diff-missing {
        color: #c0392b;
        text-decoration: line-through;
        opacity: 0.6;
        margin-right: 5px;
      }
      .diff-added {
        color: #2980b9;
        text-decoration: underline;
        font-weight: bold;
      }

      .controls {
        margin-top: 20px;
        display: flex;
        gap: 10px;
      }

      button.action-btn {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
      }

      .btn-check {
        background: #2ecc71;
        color: white;
      }
      .btn-check:hover {
        background: #27ae60;
      }
      .btn-reveal {
        background: #f39c12;
        color: white;
      }
      .btn-reset {
        background: #95a5a6;
        color: white;
      }
    </style>
  </head>
  <body>
    <div class="dictation-card">
      <h2>üéß Listening Lab - Au March√©</h2>

      <div class="level-bar">
        <button class="level-btn" id="prev-btn" onclick="changeLevel(-1)">
          ‚óÄ Prev
        </button>
        <span class="level-indicator" id="level-display">Level 1 / 10</span>
        <button class="level-btn" id="next-btn" onclick="changeLevel(1)">
          Next ‚ñ∂
        </button>
      </div>

      <div class="audio-controls">
        <button class="btn-audio" onclick="playAudio(1)">
          <span>üîä</span> Normal
        </button>
        <button class="btn-audio btn-slow" onclick="playAudio(0.6)">
          <span>üê¢</span> Slow
        </button>
      </div>

      <textarea id="user-input" placeholder="Type what you hear..."></textarea>

      <div id="feedback" class="feedback-area">
        <span style="color: #aaa; font-style: italic"
          >Feedback will appear here...</span
        >
      </div>

      <div class="controls">
        <button class="action-btn btn-check" onclick="checkDictation()">
          Check
        </button>
        <button class="action-btn btn-reset" onclick="resetDictation()">
          Reset
        </button>
        <button class="action-btn btn-reveal" onclick="revealAnswer()">
          Reveal
        </button>
      </div>
    </div>

    <script>
      // 1. The Dataset (10 Sentences from marche.md)
      const sentences = [
        "Il y a un march√© en plein air.",
        "Il y a plusieurs stands dans le parc.",
        "Il y a beaucoup de vendeurs et de clients.",
        "Un vendeur vend des l√©gumes.",
        "Une vendeuse vend du pain.",
        "Un vendeur vend du fromage et des produits artisanaux.",
        "Les tomates sont fra√Æches ?",
        "J'en prends un kilo, s'il vous pla√Æt.",
        "Elle est du jour ?",
        "Vous me conseillez quel fromage ?",
      ];

      let currentIndex = 0;

      // 2. Navigation Logic
      function changeLevel(direction) {
        currentIndex += direction;

        // Bounds checking
        if (currentIndex < 0) currentIndex = 0;
        if (currentIndex >= sentences.length)
          currentIndex = sentences.length - 1;

        updateUI();
        resetDictation(); // Clear previous inputs
      }

      function updateUI() {
        document.getElementById("level-display").innerText =
          `Level ${currentIndex + 1} / ${sentences.length}`;

        // Disable buttons at ends
        document.getElementById("prev-btn").disabled = currentIndex === 0;
        document.getElementById("next-btn").disabled =
          currentIndex === sentences.length - 1;
      }

      // 3. Audio Logic
      function playAudio(speed) {
        window.speechSynthesis.cancel(); // Stop any previous audio
        const text = sentences[currentIndex];
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = "fr-FR";
        utterance.rate = speed;

        const voices = window.speechSynthesis.getVoices();
        const frVoice = voices.find((v) => v.lang.includes("fr"));
        if (frVoice) utterance.voice = frVoice;

        window.speechSynthesis.speak(utterance);
      }

      // 4. Checking Logic
      function checkDictation() {
        const userText = document.getElementById("user-input").value.trim();
        const feedbackDiv = document.getElementById("feedback");

        if (!userText) {
          feedbackDiv.innerHTML =
            '<span style="color:#e74c3c">Please type something first!</span>';
          return;
        }
        feedbackDiv.innerHTML = compareStrings(
          sentences[currentIndex],
          userText,
        );
      }

      function revealAnswer() {
        document.getElementById("user-input").value = sentences[currentIndex];
        checkDictation();
      }

      function resetDictation() {
        document.getElementById("user-input").value = "";
        document.getElementById("feedback").innerHTML =
          '<span style="color:#aaa; font-style:italic;">Feedback will appear here...</span>';
      }

      // 5. Diff Algorithm
      function compareStrings(correct, user) {
        let html = "";
        const correctWords = correct.split(" ");
        const userWords = user.split(" ");
        const maxLength = Math.max(correctWords.length, userWords.length);

        for (let i = 0; i < maxLength; i++) {
          const cWord = correctWords[i] || "";
          const uWord = userWords[i] || "";

          // Normalize for comparison (remove punctuation, lower case)
          const cleanC = cWord.toLowerCase().replace(/[.,?]/g, "");
          const cleanU = uWord.toLowerCase().replace(/[.,?]/g, "");

          if (cleanC === cleanU) {
            html += `<span class="diff-correct">${cWord}</span> `;
          } else {
            if (cWord) html += `<span class="diff-added">${cWord}</span> `;
            if (uWord) html += `<span class="diff-missing">${uWord}</span> `;
          }
        }
        return html;
      }

      // Init
      updateUI();
      window.speechSynthesis.onvoiceschanged = () => {};
    </script>
    <script type="module" src="../../../../assets/js/nav-utensils.js"></script>
  </body>
</html>
