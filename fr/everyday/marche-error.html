<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Audio Error Detection</title>
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-CHXHM9CZKM"
    ></script>

    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-CHXHM9CZKM");
    </script>

    <!-- Favicons -->
    <link href="/img/favicon.png" rel="icon" />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
      :root {
        --primary: #e74c3c;
        --bg: #fdf2f2;
      }
      body {
        font-family: "Segoe UI", sans-serif;
        background: var(--bg);
        padding: 40px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .game-card {
        background: white;
        padding: 40px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        text-align: center;
        max-width: 600px;
        width: 100%;
      }

      /* Audio Button */
      .listen-btn {
        background: var(--primary);
        color: white;
        border: none;
        width: 70px;
        height: 70px;
        border-radius: 50%;
        font-size: 30px;
        cursor: pointer;
        margin-bottom: 30px;
        box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        transition: transform 0.2s;
      }
      .listen-btn:hover {
        transform: scale(1.1);
      }
      .listen-btn:active {
        transform: scale(0.95);
      }

      /* Text Display */
      .sentence-display {
        font-size: 1.5rem;
        line-height: 1.6;
        color: #333;
      }
      .word {
        cursor: pointer;
        padding: 5px 8px;
        border-radius: 5px;
        transition: background 0.2s;
        display: inline-block;
      }
      .word:hover {
        background: #eee;
      }

      /* States */
      .word.correct-catch {
        background: #27ae60;
        color: white;
        text-decoration: none;
      }
      .word.wrong-catch {
        background: #e74c3c;
        color: white;
        animation: shake 0.4s;
      }
      .correction-popup {
        display: block;
        font-size: 0.9rem;
        margin-top: 5px;
        color: #ffd700;
        font-weight: bold;
      }

      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-5px);
        }
        75% {
          transform: translateX(5px);
        }
      }

      .nav-btn {
        margin-top: 30px;
        padding: 10px 25px;
        border: none;
        background: #333;
        color: white;
        border-radius: 5px;
        cursor: pointer;
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="game-card">
      <h2>üïµÔ∏è‚Äç‚ôÄÔ∏è Find the Imposter</h2>
      <p style="color: #777; margin-bottom: 20px">
        Listen to the audio. One word below is wrong. Click it!
      </p>

      <button class="listen-btn" onclick="playCurrent()">üîä</button>

      <div class="sentence-display" id="sentence-area"></div>

      <button class="nav-btn" id="next-btn" onclick="nextLevel()">
        Next Exercise ‚Üí
      </button>
    </div>

    <script>
      // DATA: Audio is the TRUTH. Text has the LIE.
      // We map the index of the word that is wrong (0-based index of the visible text).
      const levels = [
        {
          audio: "Il y a un march√© en plein air",
          text: "Il y a un supermarch√© en plein air",
          lieIndex: 4, // "supermarch√©"
          correction: "march√©",
        },
        {
          audio: "Le march√© est entour√© d'arbres",
          text: "Le march√© est entour√© de voitures",
          lieIndex: 5, // "voitures"
          correction: "d'arbres",
        },
        {
          audio: "Un vendeur vend des l√©gumes",
          text: "Un vendeur mange des l√©gumes",
          lieIndex: 2, // "mange"
          correction: "vend",
        },
        {
          audio: "payer par carte",
          text: "payer par ch√®que",
          lieIndex: 2, // "ch√®que"
          correction: "carte",
        },
        {
          audio: "c'est trop cher",
          text: "c'est pas cher",
          lieIndex: 1, // "pas"
          correction: "trop",
        },
      ];

      let current = 0;

      function init() {
        const container = document.getElementById("sentence-area");
        container.innerHTML = "";
        document.getElementById("next-btn").style.display = "none";

        const lvl = levels[current];
        const words = lvl.text.split(" ");

        words.forEach((w, i) => {
          const span = document.createElement("span");
          span.innerText = w;
          span.className = "word";
          span.onclick = () => check(span, i);
          container.appendChild(span);
          // Add space
          container.appendChild(document.createTextNode(" "));
        });
      }

      function playCurrent() {
        const audioName = levels[current].audio;
        // Use actual audio files from /media/everyday/marche/
        const filename = audioName.trim().replace(/'/g, "_");
        const audio = new Audio(`/media/everyday/marche/${filename}.mp3`);
        audio.play().catch((e) => console.error("Audio play error:", e));
      }

      function check(element, index) {
        const lvl = levels[current];

        if (index === lvl.lieIndex) {
          // Success
          element.className = "word correct-catch";
          element.innerHTML = `${element.innerText} <br><span class='correction-popup'>‚ûù ${lvl.correction}</span>`;
          document.getElementById("next-btn").style.display = "inline-block";
          disableAll();
        } else {
          // Fail
          element.className = "word wrong-catch";
          setTimeout(() => {
            element.className = "word";
          }, 500); // Reset after shake
        }
      }

      function disableAll() {
        const words = document.querySelectorAll(".word");
        words.forEach((w) => (w.onclick = null));
      }

      function nextLevel() {
        current = (current + 1) % levels.length;
        init();
      }

      init();
    </script>
  </body>
</html>
