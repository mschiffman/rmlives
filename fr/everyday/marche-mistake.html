<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Error Detection</title>

    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-CHXHM9CZKM"
    ></script>

    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-CHXHM9CZKM");
    </script>

    <!-- Favicons -->
    <link href="/img/favicon.png" rel="icon" />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />

    <link rel="stylesheet" href="../../../../assets/css/reorder.css" />
    <style>
      .clickable-word {
        cursor: pointer;
        padding: 4px 6px;
        border-radius: 4px;
        transition: background 0.2s;
      }

      .clickable-word:hover {
        background-color: #e0e0e0;
      }

      .found-error {
        background-color: #fab1a0; /* Red-ish background for the error */
        color: #c0392b;
        font-weight: bold;
        cursor: default;
      }

      .correction-highlight {
        color: #27ae60;
        font-weight: bold;
        margin-left: 5px;
      }

      .wrong-choice {
        animation: shake 0.3s;
        background-color: #ecf0f1;
      }

      @keyframes shake {
        0% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-5px);
        }
        50% {
          transform: translateX(5px);
        }
        75% {
          transform: translateX(-5px);
        }
        100% {
          transform: translateX(0);
        }
      }
    </style>
  </head>
  <body>
    <div class="scramble-container">
      <h2>üîç Critical Analysis (Error Detection)</h2>
      <p class="text-center text-muted mb-5">
        Click words to build the sentence. Capital letters start the sentence!
      </p>

      <div id="exercises-area"></div>

      <div class="controls">
        <button class="btn-verify" onclick="checkAll()">Check Answers</button>
        <button class="btn-reset" onclick="resetAll()">Reset</button>
      </div>
    </div>

    <script>
      // 1. Data: Sentences with *Errors* and | Corrections based on marche.md
      const exerciseData = [
        "Il y a un march√© en plein *mer* | air",
        "Le march√© est entour√© de *voitures* | d'arbres",
        "Un vendeur vend des *chaussures* | l√©gumes",
        "Une vendeuse vend du *sable* | pain",
        "Un client parle avec un *robot* | vendeur",
        "Les stands ont des auvents *invisibles* | color√©s",
        "Il y a des paniers *sous* les tables | sur",
        "L'ambiance est *stressante* et conviviale | calme",
        "Le march√© a lieu pendant la *nuit* | journ√©e",
        "Je voudrais un *litre* de tomates | kilo",
        "Les tomates sont *bleues* | fra√Æches",
        "Ce poisson est *pourri* | frais",
        "Je peux payer en *chansons* | esp√®ces",
        "C'est des produits *import√©s* | locaux",
        "Cette baguette est *vieille* | fra√Æche",
        "Le march√© a lieu tous les samedis *matins* | matin",
        "Les vendeurs *install* leurs stands √† l'aube | installent",
        "On trouve des l√©gumes frais *est* de saison | et",
        "Une cliente demande le *pris* des tomates | prix",
        "Le poissonnier vend du poisson *fra√Æche* | frais",
        "Les fruits sont dispos√©s dans des *cageot* en bois | cageots",
        "Un vendeur p√®se un kilo *des* pommes | de",
        "L'ambiance du march√© est tr√®s *anim√©* | anim√©e",
        "Les clients choisissent leurs produits avec *soins* | soin",
        "Cette boulang√®re fait du pain *artisanale* | artisanal",
        "On peut payer en esp√®ces ou *en* carte | par",
        "Les stands sont prot√©g√©s par des auvents *color√©* | color√©s",
        "Je voudrais *une* demi-kilo de cerises | un",
        "Ces tomates viennent *de* producteur local | du",
        "Le march√© se termine *√†* midi | vers",
      ];

      const container = document.getElementById("exercises-area");

      // 2. Init: Render the DOM
      function init() {
        container.innerHTML = ""; // Clear
        exerciseData.forEach((item, index) => {
          parseAndCreateRow(item, index);
        });
      }

      function parseAndCreateRow(item, index) {
        // Parse the string: "Wrong *Word* | Right"
        const [sentencePart, correctionPart] = item.split("|");
        const correction = correctionPart.trim();

        // Find the error word marked with *
        // Regex captures: 1=Pre, 2=ErrorWord, 3=Post
        const match = sentencePart.match(/(.*)\*(.*)\*(.*)/);

        let pre = "",
          errorWord = "",
          post = "";
        if (match) {
          pre = match[1];
          errorWord = match[2];
          post = match[3];
        } else {
          // Fallback if formatting is wrong
          pre = sentencePart;
        }

        // Create HTML structure
        const row = document.createElement("div");
        row.className = "exercise-row";

        // We need to split the "Pre" and "Post" into clickable words too,
        // so the user doesn't know which one is the error just by inspecting HTML structure easily.
        // We will build a single array of words to render.

        const cleanSentence = (pre + errorWord + post)
          .replace(/\s+/g, " ")
          .trim();
        const allWords = cleanSentence.split(" ");

        // Find the index of the error word by counting words in the pre-text
        const preWords = pre.trim().split(/\s+/).filter((w) => w !== "");
        const errorIndex = preWords.length;

        row.innerHTML = `
      <div class="prompt">Find the mistake: ${index + 1}</div>
      <div class="sentence-container" id="sent-${index}">
        </div>
      <div class="feedback-text" id="fb-${index}" style="display:none;"></div>
  `;

        container.appendChild(row);

        const sentenceContainer = document.getElementById(`sent-${index}`);

        // Render words
        allWords.forEach((word, wordIndex) => {
          const span = document.createElement("span");
          span.className = "clickable-word";
          span.innerText = word;

          // Check if this is the error word by matching both content and position
          if (wordIndex === errorIndex && errorWord !== "") {
            span.dataset.status = "error"; // Secretly mark it
          } else {
            span.dataset.status = "neutral";
          }

          span.onclick = function () {
            handleWordClick(this, correction, index);
          };

          sentenceContainer.appendChild(span);
          // Add a space after words
          sentenceContainer.appendChild(document.createTextNode(" "));
        });
      }

      // 3. Logic: Handle Click
      function handleWordClick(element, correction, index) {
        const fb = document.getElementById(`fb-${index}`);

        // Reset other words in this row
        const parent = element.parentElement;
        Array.from(parent.children).forEach((child) => {
          child.classList.remove("wrong-choice");
        });

        if (element.dataset.status === "error") {
          // Correct detection!
          element.classList.add("found-error");
          element.innerHTML = `<strike>${element.innerText}</strike> <span class="correction-highlight">${correction}</span>`;

          fb.style.display = "block";
          fb.style.color = "#27ae60";
          fb.innerText = `‚úÖ Correct! "${element.innerText.split(" ")[0]}" should be "${correction}".`;

          // Disable further clicks in this row
          Array.from(parent.children).forEach(
            (child) => (child.onclick = null),
          );
        } else {
          // Wrong guess
          element.classList.add("wrong-choice");
          fb.style.display = "block";
          fb.style.color = "#c0392b";
          fb.innerText = "‚ùå That word is correct. Try again.";
        }
      }

      // Initialize
      init();

      // Initialize on load
      init();

      // 5. Reset Logic
      function resetAll() {
        init(); // Just re-render everything from scratch
      }

      // Start
      init();
    </script>
    <script type="module" src="../../../../assets/js/nav-utensils.js"></script>
  </body>
</html>
